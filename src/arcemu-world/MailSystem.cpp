/*
 * ArcEmu MMORPG Server
 * Copyright (C) 2005-2007 Ascent Team <http://www.ascentemu.com/>
 * Copyright (C) 2008 <http://www.ArcEmu.org/>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 */

#include "StdAfx.h"
initialiseSingleton(MailSystem);

void MailSystem::StartMailSystem()
{

}

MailError MailSystem::DeliverMessage(uint64 recipent, MailMessage* message)
{
	// assign a new id
	message->message_id = Generate_Message_Id();

	Player * plr = objmgr.GetPlayer((uint32)recipent);
	if(plr != NULL)
	{
		plr->m_mailBox.AddMessage(message);
		if((uint32)UNIXTIME >= message->delivery_time)
		{
			uint32 v = 0;
			plr->GetSession()->OutPacket(SMSG_RECEIVED_MAIL, 4, &v);
		}
	}

	SaveMessageToSQL(message);
	return MAIL_OK;
}

void Mailbox::AddMessage(MailMessage* Message)
{
	Messages[Message->message_id] = *Message;
}

void Mailbox::DeleteMessage(uint32 MessageId, bool sql)
{
	Messages.erase(MessageId);
	if(sql)
		CharacterDatabase.WaitExecute("DELETE FROM mailbox WHERE message_id = %u", MessageId);
}

WorldPacket * Mailbox::BuildMailboxListingPacket()
{
	/*
13329
02 00 00 00 
02 
67 01 91 1C 6F 02 03 17 71 00 00 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 C3 FF EF 41 00 00 00 00 43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 01 00 69 F6 7A 60 AD A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C0 37 E8 2B 01 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 CB 01 90 1C 6F 02 03 4A 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 C3 FF EF 41 00 00 00 00 57 6F 57 27 73 20 36 74 68 20 41 6E 6E 69 76 65 72 73 61 72 79 21 00 57 6F 77 2C 20 61 6E 6F 74 68 65 72 20 79 65 61 72 20 68 61 73 20 67 6F 6E 65 20 62 79 20 66 6F 72 20 57 6F 57 21 0D 0A 0D 0A 57 65 20 77 61 6E 74 65 64 20 74 6F 20 74 68 61 6E 6B 20 79 6F 75 20 61 67 61 69 6E 20 66 6F 72 20 63 6F 6E 74 69 6E 75 69 6E 67 20 74 6F 20 70 6C 61 79 20 57 6F 72 6C 64 20 6F 66 20 57 61 72 63 72 61 66 74 20 77 69 74 68 20 75 73 2E 20 57 69 74 68 20 74 68 65 20 72 65 74 75 72 6E 20 6F 66 20 61 20 63 65 72 74 61 69 6E 20 76 65 72 79 20 6C 61 72 67 65 20 64 72 61 67 6F 6E 20 28 73 70 6F 69 6C 65 72 20 61 6C 65 72 74 21 29 2C 20 74 68 69 73 20 69 73 20 67 6F 69 6E 67 20 74 6F 20 62 65 20 61 20 72 6F 75 67 68 20 79 65 61 72 20 66 6F 72 20 74 68 65 20 77 6F 72 6C 64 20 6F 66 20 41 7A 65 72 6F 74 68 2E 20 4F 6E 20 74 68 65 20 6F 74 68 65 72 20 68 61 6E 64 2C 20 74 68 61 74 20 6D 65 61 6E 73 20 68 65 72 6F 65 73 20 61 72 65 20 67 6F 69 6E 67 20 74 6F 20 62 65 20 6E 65 65 64 65 64 20 6D 6F 72 65 20 74 68 61 6E 20 65 76 65 72 2E 0D 0A 0D 0A 47 65 74 20 6F 75 74 20 74 68 65 72 65 20 61 6E 64 20 64 65 66 65 6E 64 20 61 20 73 68 61 74 74 65 72 65 64 20 77 6F 72 6C 64 21 0D 0A 0D 0A 54 68 65 20 57 6F 57 20 44 65 76 20 54 65 61 6D 00 00 

	24 mails 
{SERVER} Packet: (0x023B) SMSG_MAIL_LIST_RESULT PacketSize = 4325 TimeStamp = 31645068
18 00 00 00 18 B4 00 C6 FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 AC FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 FA 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 81 FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9A FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 B0 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 3B FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 88 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 75 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 0C FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 7C FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 32 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 E8 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 70 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 13 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 97 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D8 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 79 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 51 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 C4 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 47 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 3F FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 03 8C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 FF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 2D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 4C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 DF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 21 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 29 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8E FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 02 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4F 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 5A FA 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9B FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 A4 4E 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8C F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 58 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 62 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 46 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 92 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 38 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 34 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 35 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 F8 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 1C FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 F4 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A5 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 03 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 AA 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 61 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 EB FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 66 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 15 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 D3 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 1F 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 C3 F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 B5 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 CB 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 7D F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 A2 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 94 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 2F F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 27 68 2B 32 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 8A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 48 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A2 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D4 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 04 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 29 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 0F 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
//3 mails 3.3.3
03 00 00 00 
03 
47 01 8A 06 43 69 03 17 71 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 87 FF EF 41 00 00 00 00 43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 01 00 AA FB 46 47 AD A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 E0 E9 45 1B 01 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 AE 00 5F F6 42 69 00 6E DD FC 01 00 00 00 04 65 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 0A E2 3F 40 00 00 00 00 74 65 73 74 31 00 74 65 73 74 31 00 01 00 85 EB 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AC 00 94 E8 42 69 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 29 00 00 00 65 00 00 00 10 00 00 00 87 F9 F7 41 00 00 00 00 74 65 73 74 00 74 65 73 74 00 01 00 A7 DC 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

14333
{SERVER} Packet: (0xF63A) SMSG_MAIL_LIST_RESULT PacketSize = 288 TimeStamp = 13745918
02 00 00 00 
02 
D8 00 3B 65 52 3C 03 C1 D4 00 00 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 A8 61 00 00 00 00 00 00 10 00 00 00 3E EF EF 41 00 00 00 00 52 65 63 6C 61 69 6D 65 64 20 4B 65 79 00 57 65 20 64 69 73 63 6F 76 65 72 65 64 20 61 20 6B 65 79 20 62 65 6C 6F 6E 67 69 6E 67 20 74 6F 20 79 6F 75 20 69 6E 20 74 68 65 20 74 77 69 73 74 69 6E 67 20 6E 65 74 68 65 72 20 61 6E 64 20 6E 6F 74 65 64 20 74 68 61 74 20 69 74 20 77 61 73 20 6E 6F 20 6C 6F 6E 67 65 72 20 75 73 65 66 75 6C 2E 0D 0A 0D 0A 50 6C 65 61 73 65 20 61 63 63 65 70 74 20 74 68 69 73 20 72 65 63 6F 6D 70 65 6E 73 65 20 69 6E 20 6C 69 65 75 20 6F 66 20 79 6F 75 72 20 6B 65 79 2E 00 00 43 00 2F 5E 52 3C 00 61 77 F4 02 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 11 00 00 00 3A 6D 3F 40 00 00 00 00 73 68 61 72 65 00 62 65 20 68 61 70 70 79 00 00
*/
	// do cleanup on old mails mail. Before sending mail list size
	CleanupExpiredMessages();

	WorldPacket * data = new WorldPacket(SMSG_MAIL_LIST_RESULT, 500);
	MessageMap::iterator itr;
	uint32 count = 0;
	uint32 t = (uint32)UNIXTIME;
	*data << uint32( Messages.size() );	 // mail count including unsent ones
	*data << uint8( count );	 // size placeholder

	for(itr = Messages.begin(); itr != Messages.end(); ++itr)
	{
		if(itr->second.expire_time && t > itr->second.expire_time)
			continue;	   // expired mail -> skip it

		if((uint32)UNIXTIME < itr->second.delivery_time)
			continue;		// undelivered
		
		if(itr->second.AddMessageDataToPacket(*data))
			++count;
		
		if(count == 18)
			break;
	}

	const_cast<uint8*>(data->contents())[4] = count;

	return data;
}

void Mailbox::CleanupExpiredMessages()
{
	MessageMap::iterator itr, it2;
	uint32 curtime = (uint32)UNIXTIME;

	for(itr = Messages.begin(); itr != Messages.end();)
	{
		it2 = itr++;
		if(it2->second.expire_time && it2->second.expire_time < curtime)
			DeleteMessage( it2->second.message_id, true ); // !changes list !
	}
}

bool MailMessage::AddMessageDataToPacket(WorldPacket& data)
{
	uint8 i = 0;
	uint32 j;
	size_t pos;
	vector<uint64>::iterator itr;
	Item * pItem;

/*
{SERVER} Packet: (0x023B) SMSG_MAIL_LIST_RESULT PacketSize = 4325 TimeStamp = 31645068
18 00 00 00 - real mail count
18 - mail count

B4 00 
C6 FD 87 53
00 message_id
6E DD FC 01 00 00 00 04 sender_guid
00 00 00 00 cod
00 00 00 00 message_id
00 00 00 00 ?
29 00 00 00 stationery
00 00 00 00 money
00 00 00 00 message_type
AC FE F7 41 expire_time
00 00 00 00 ?
43 6F 61 72 73 65 20 54 68 72 65 61 64 00 subject
01 items
00 index
FA 51 7D 31 guid
10 09 00 00 entry
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 enchants
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 ITEM_FIELD_RANDOM_PROPERTIES_ID
00 00 00 00 GetItemRandomSuffixFactor
00 00 00 00 ITEM_FIELD_STACK_COUNT
00 00 00 00 GetChargesLeft
00 00 00 00 ITEM_FIELD_MAXDURABILITY
01 00 00 00 ITEM_FIELD_DURABILITY
00 ?
B4 00 
81 FD 87 53
00 
6E DD FC 01 00 00 00 04
00 00 00 00 
00 00 00 00
00 00 00 00
29 00 00 00
00 00 00 00 
00 00 00 00 
9A FE F7 41 
00 00 00 00
43 6F 61 72 73 65 20 54 68 72 65 61 64 00 
01 
00 
B0 51 7D 31
10 09 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 
00 00 00 00 
01 00 00 00 
00 00 00 00 
00 00 00 00 
00 00 00 00 
00 
B4 00 3B FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 88 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 75 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 0C FD 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 7C FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 32 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 E8 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 70 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 13 51 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 97 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D8 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 79 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 51 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 C4 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 47 FC 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 3F FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 03 8C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 FF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 2D FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 4C 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 DF FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 21 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 29 50 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8E FB 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 02 FE F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4F 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 5A FA 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 9B FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 A4 4E 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 8C F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 58 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D7 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 62 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 46 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 92 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 38 F9 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 34 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 35 4D 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 F8 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 1C FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 F4 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A5 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 03 FD F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 AA 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 61 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 EB FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 66 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 15 F8 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 D3 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 1F 4C 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 C3 F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 B5 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 CB 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 7D F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 A2 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 94 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 2F F7 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 27 68 2B 32 00 00 00 00 29 00 00 00 00 00 00 00 10 00 00 00 8A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 48 4B 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 A2 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 5A FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 D4 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 B4 00 04 F6 87 53 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 29 00 00 00 00 00 00 00 00 00 00 00 29 FC F7 41 00 00 00 00 43 6F 61 72 73 65 20 54 68 72 65 61 64 00 01 00 0F 4A 7D 31 10 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

//3.3.3
47 01 - magic
8A 06 43 69 id
03 type
17 71 00 00 guid
00 00 00 00 cod
00 00 00 00 ?
29 00 00 00 stationery
00 00 00 00 gold
10 00 00 00 non auction mail
87 FF EF 41 remaining days
00 00 00 00 mail template
43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 - subject
48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 - body
01 - 1 item
00 - subindex
AA FB 46 47 guid
AD A0 00 00 entry
00 00 00 00 00 00 00 00 00 00 00 00 enchant 1
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 random prop
E0 E9 45 1B random suff
01 00 00 00 stack
FF FF FF FF charges
00 00 00 00 maxdur
00 00 00 00 dur
00 ?
AE 00 
5F F6 42 69 
00 
6E DD FC 01 00 00 00 04
65 00 00 00
00 00 00 00 
29 00 00 00 
00 00 00 00 
10 00 00 00 
0A E2 3F 40 00 00 00 00 74 65 73 74 31 00 74 65 73 74 31 00 01 00 85 EB 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AC 00 94 E8 42 69 00 6E DD FC 01 00 00 00 04 00 00 00 00 00 00 00 00 29 00 00 00 65 00 00 00 10 00 00 00 87 F9 F7 41 00 00 00 00 74 65 73 74 00 74 65 73 74 00 01 00 A7 DC 46 47 FD 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1E F4 C9 71 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

13329
02 00 00 00 
02 
67 01 - magic
91 1C 6F 02 id 
03 type
17 71 00 00 guid
00 00 00 00 cod
00 00 00 00 ?
00 00 00 00 new in 4.0.3
29 00 00 00 stationary
00 00 00 00 money 
00 00 00 00 new in 4.0.3
10 00 00 00 type
C3 FF EF 41 time
00 00 00 00 mail template
43 68 69 6C 6C 79 20 74 68 65 20 50 65 6E 67 75 69 6E 00 subject
48 65 6C 6C 6F 21 0D 0A 0D 0A 50 6C 65 61 73 65 20 67 69 76 65 20 61 20 77 61 72 6D 20 77 65 6C 63 6F 6D 65 20 74 6F 20 79 6F 75 72 20 6E 65 77 20 63 6F 6F 6C 20 70 65 6E 67 75 69 6E 20 70 61 6C 21 0D 0A 0D 0A 49 27 6D 20 73 6F 20 68 61 70 70 79 20 79 6F 75 20 63 6F 75 6C 64 20 67 69 76 65 20 74 68 69 73 20 73 61 73 73 79 20 6C 69 74 74 6C 65 20 53 70 68 65 6E 69 73 63 69 64 61 65 20 61 20 68 6F 6D 65 2E 0D 0A 0D 0A 2D 2D 42 72 65 61 6E 6E 69 00 
01 item count
00 block index
69 F6 7A 60 guid
AD A0 00 00 entry
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 enchant
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 rprop
C0 37 E8 2B rsufix
01 00 00 00 stack
FF FF FF FF charges
00 00 00 00 durability
00 00 00 00
00 
CB 01 
90 1C 6F 02 
03 
4A 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
29 00 00 00 
00 00 00 00 
00 00 00 00 
10 00 00 00 
C3 FF EF 41 00 00 00 00 57 6F 57 27 73 20 36 74 68 20 41 6E 6E 69 76 65 72 73 61 72 79 21 00 57 6F 77 2C 20 61 6E 6F 74 68 65 72 20 79 65 61 72 20 68 61 73 20 67 6F 6E 65 20 62 79 20 66 6F 72 20 57 6F 57 21 0D 0A 0D 0A 57 65 20 77 61 6E 74 65 64 20 74 6F 20 74 68 61 6E 6B 20 79 6F 75 20 61 67 61 69 6E 20 66 6F 72 20 63 6F 6E 74 69 6E 75 69 6E 67 20 74 6F 20 70 6C 61 79 20 57 6F 72 6C 64 20 6F 66 20 57 61 72 63 72 61 66 74 20 77 69 74 68 20 75 73 2E 20 57 69 74 68 20 74 68 65 20 72 65 74 75 72 6E 20 6F 66 20 61 20 63 65 72 74 61 69 6E 20 76 65 72 79 20 6C 61 72 67 65 20 64 72 61 67 6F 6E 20 28 73 70 6F 69 6C 65 72 20 61 6C 65 72 74 21 29 2C 20 74 68 69 73 20 69 73 20 67 6F 69 6E 67 20 74 6F 20 62 65 20 61 20 72 6F 75 67 68 20 79 65 61 72 20 66 6F 72 20 74 68 65 20 77 6F 72 6C 64 20 6F 66 20 41 7A 65 72 6F 74 68 2E 20 4F 6E 20 74 68 65 20 6F 74 68 65 72 20 68 61 6E 64 2C 20 74 68 61 74 20 6D 65 61 6E 73 20 68 65 72 6F 65 73 20 61 72 65 20 67 6F 69 6E 67 20 74 6F 20 62 65 20 6E 65 65 64 65 64 20 6D 6F 72 65 20 74 68 61 6E 20 65 76 65 72 2E 0D 0A 0D 0A 47 65 74 20 6F 75 74 20 74 68 65 72 65 20 61 6E 64 20 64 65 66 65 6E 64 20 61 20 73 68 61 74 74 65 72 65 64 20 77 6F 72 6C 64 21 0D 0A 0D 0A 54 68 65 20 57 6F 57 20 44 65 76 20 54 65 61 6D 00 00 
*/
	// add stuff
	if(deleted_flag)
	{ 
		return false;
	}

	data << uint16(0x0043);
	data << message_id;
	data << uint8(message_type);	//blizz employe mail ?
	if(message_type)
		data << uint32(sender_guid);
	else
		data << sender_guid;

	data << cod;			// cod
//	data << message_id;		// itempageid
	data << uint32(0);
	data << uint32(0);		// new in 4.0.3
	data << stationery;
	data << money;		// money
	data << uint32(0);		// new in 4.0.3
	data << uint32((message_type == AUCTION ? 0x04 : 0x10));
	data << float(float(expire_time - (uint32)UNIXTIME) / (60*60*24.0f) );
	data << uint32(0); //mail template (MailTemplate.dbc)
	data << subject;
	data << body;
	pos = data.wpos();
	data << uint8(0);		// item count

	if( !items.empty( ) )
	{
		for( itr = items.begin( ); itr != items.end( ); ++itr )
		{
			pItem = objmgr.LoadItem( *itr );
			if( pItem == NULL )
				continue;

			data << uint8(i++);
			data << pItem->GetUInt32Value(OBJECT_FIELD_GUID);
			data << pItem->GetEntry();

			for( j = 0; j < 9; ++j )
			{
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_1 + ( j * 3 ) );
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_2 + ( j * 3 ) );
				data << pItem->GetUInt32Value( ITEM_FIELD_ENCHANTMENT_1_3 + ( j * 3 ) );
			}

			data << pItem->GetUInt32Value( ITEM_FIELD_RANDOM_PROPERTIES_ID );
			if( ( (int32)pItem->GetUInt32Value( ITEM_FIELD_RANDOM_PROPERTIES_ID ) ) < 0 )
                data << pItem->GetItemRandomSuffixFactor();
			else
				data << uint32( 0 );

			data << uint32( pItem->GetUInt32Value(ITEM_FIELD_STACK_COUNT) );
			data << uint32( pItem->GetChargesLeft() );
			data << pItem->GetUInt32Value( ITEM_FIELD_MAXDURABILITY );
			data << pItem->GetUInt32Value( ITEM_FIELD_DURABILITY );
//			data << uint32( 0 );	//new in 4.0.3
			data << uint8( 0 );
			//we are done using this item. Now we can delete it ?
			//pItem->DeleteMe();
			pItem = NULL;
		}

		data.put< uint8 >( pos, i );
	}

	return true;
}

void MailSystem::SaveMessageToSQL(MailMessage * message)
{
	stringstream ss;
	vector< uint64 >::iterator itr;
	ss << "REPLACE INTO mailbox VALUES("
		<< message->message_id << ","
		<< message->message_type << ","
		<< message->player_guid << ","
		<< message->sender_guid << ",\""
		<< CharacterDatabase.EscapeString(message->subject) << "\",\""
		<< CharacterDatabase.EscapeString(message->body) << "\","
		<< message->money << ",'";

	for( itr = message->items.begin( ); itr != message->items.end( ); ++itr )
		ss << (*itr) << ",";

	ss << "'," 
		<< message->cod << ","
		<< message->stationery << ","
		<< message->expire_time << ","
		<< message->delivery_time << ","
		<< message->copy_made << ","
		<< message->read_flag << ","
		<< message->deleted_flag << ")";
	CharacterDatabase.WaitExecute(ss.str().c_str());
}

void WorldSession::HandleSendMail(WorldPacket & recv_data )
{
#ifdef FORCED_GM_TRAINEE_MODE
	if( CanUseCommand('k') && !HasGMPermissions() )
	{
		GetPlayer()->BroadcastMessage( "You are not allowed to use this feature" );
		return;
	}
#endif
	if( sWorld.getIntRate( INTRATE_DISABLE_MAIL_FEATURE ) )
	{
		GetPlayer()->BroadcastMessage( "Mail feature is disabled right now" );
		return;
	}
	/*
	320 client
{CLIENT} Packet: (0x0238) CMSG_SEND_MAIL PacketSize = 60 TimeStamp = 31476306
54 0E 00 03 33 02 10 F1 
61 00 
43 6F 61 72 73 65 20 54 68 72 65 61 64 00
00
29 00 00 00 
00 00 00 00 
01 -itemcount
00 -slot
A8 20 DA E3 01 00 00 44 guid
00 00 00 00 
00 00 00 00 
00 00 00 00 ?
00 00 00 00 ?
00 ?

13329
{CLIENT} Packet: (0x067D) CMSG_SEND_MAIL PacketSize = 87 TimeStamp = 2929078
6A 01 00 00 89 27 13 F1 guid
53 69 63 6B 74 65 61 72 00 - Sicktear -> target
53 6F 6C 69 64 20 53 74 6F 6E 65 20 28 32 30 29 00 -Solid Stone (20) -> subject
00 -> body
29 00 00 00 stationary
00 00 00 00 ?
02 item count
00 slot
3E 03 FE B1 02 00 00 41 
01 
3E DE 2A AF 02 00 00 41 
A0 86 01 00 
00 00 00 00 
00 00 00 00 
00 00 00 00 
00 00 00 00
00 00 00 00 00 
14333
{CLIENT} Packet: (0x4010) CMSG_SEND_MAIL PacketSize = 63 stamp = 2290500
8C ?
00 00 00 00 00 00 00 00 COD
29 00 00 00 stationary
02 00 00 00 item count
00 00 00 00 
75 27 00 00 00 00 00 00 gold
74 65 73 74 00 subject test
66 6C 79 00 fly - charname of destination
F0 ?
63 6F 6E 74 65 6E 74 00 - content
C1 ?
B5 10110101
B5 10110101
00 itemslot
F9 99 45 40 08 =-> F8 98 44 41 09 -> 98 41 F8 09 00 00 00 44 -> go2 go0 go7 go1 go3
01 itemslot
F9 96 45 40 08 =-> F8 97 44 41 09 -> 
06 ?

DD 11011101
00 00 00 00 00 00 00 00
29 00 00 00 
0C 00 00 00 
00 00 00 00 
10 27 00 00 00 00 00 00 
61 00 
61 00 
F0 go7
61 00 
C1 go6
10 go3
05 B5 21 B5 11 81 15 15 15 15 15 15 12 masks
00 45 7E 01 F9 9D 45 40 08 02 45 7E 03 F9 96 45 40 08 04 7E 45 05 7E 45 06 05 45 7E 07 02 45 7E 08 04 45 7E 09 07 45 7E 0A 03 45 7E 0B 06 45 7E items
45 go0
32 go1
23 go2                              

1C - 00011100
00 00 00 00 00 00 00 00 
29 00 00 00
01 00 00 00
00 00 00 00
10 27 00 00 00 00 00 00 
61 00 
61 00 
F0 go7
61 00 
C1 go6
23 go3
15 00 05 45 7E mask + guid


{CLIENT} Packet: (0x4010) CMSG_SEND_MAIL PacketSize = 73 stamp = 4859103
8C - go mask 10001100
75 27 00 00 00 00 00 00 COD
29 00 00 00 stationary
05 00 00 00 itemcount
00 00 00 00 
00 00 00 00 00 00 00 00 gold
61 62 63 64 65 00 subject
66 6C 79 00 dest char
F0 - go7
62 63 64 65 66 63 63 00 content
C1 - go6
11 00010001
21 00100001
81 10000001
05 00000101
15 00010101
00 slot
7E 45 guid
01 slot
45 7E guid
02 slot
7E 45 guid
03 slot
45 7E guid
04 slot
00 45 7E guid
06 - go0
*/
#define MAX_MAIL_ITEMS 12
	MailMessage msg;
//	uint64 gameobject;
	uint32 unk2;
	uint32 itemcount;
	uint8 itemslot;
	uint8 i;
	vector< Item* > items;
	vector< Item* >::iterator itr;
	string recepient;
	Item * pItem;
	uint8 go_guid_mask; //bit7=g[0] bit4=g[3] bit2/3=g6/7 
	uint8 go_guid_byte;	//intentionally using 1 byte instead 8 because i do not have the patience to decode properly GO guid
	//uint32 err = MAIL_OK;

	recv_data >> go_guid_mask;

	uint64 COD;
	recv_data >> COD;
	msg.cod = (uint32)COD;

	recv_data >> msg.stationery;

	recv_data >> itemcount;
	if( itemcount > MAX_MAIL_ITEMS )
	{
		//SystemMessage("Sorry, Ascent does not support sending multiple items at this time. (don't want to lose your item do you) Remove some items, and try again.");
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:You want to send %d items, but server has a limit of %d", itemcount, MAX_MAIL_ITEMS );
		return;
	}
	recv_data >> unk2;

	uint64 gold;
	recv_data >> gold;
	msg.money = (uint32)gold;

	recv_data >> msg.subject;
	recv_data >> recepient;

	recv_data >> go_guid_byte; //go[7]
	recv_data >> msg.body;
	recv_data >> go_guid_byte; //go[6]
	

	//he simply ads ' ' after each '%' to string so that vsnprintf function would not find tokens in string
	char *t=(char*)msg.subject.c_str();
	if( t[0] != 0 ) //if not an empty string
	{
		uint32 ind=0;
		size_t maxlen = strlen( t ); //let's hope we can find the string terminator
		//make sure we do not have any recognizable tokens here
		while(t[ind]!=0 && ind<maxlen)
		{
			if(t[ind]=='%')
				*(unsigned char *)&t[ind]='P';//just remove chars that could be interpreted
			ind++;
		}
	}
	msg.subject = t;
	t=(char*)msg.body.c_str();
	if( t[0] != 0 ) //if not an empty string
	{
		uint32 ind=0;
		size_t maxlen = strlen( t );//let's hope we can find the string terminator
		while(t[ind]!=0 && ind<maxlen)
		{
			if(t[ind]=='%')
				*(unsigned char *)&t[ind]='P';//just remove chars that could be interpreted
			ind++;
		}
	}
	msg.body = t;

	// Search for the recipient
	PlayerInfo* player = ObjectMgr::getSingleton().GetPlayerInfoByName(recepient.c_str());
	if( player == NULL )
	{
		SendMailError( MAIL_ERR_RECIPIENT_NOT_FOUND );
		GetPlayer()->BroadcastMessage( "MailError:Could not find destination char" );
		return;
	}

	uint8 item_guid_masks[ MAX_MAIL_ITEMS ];
	for( i = 0; i < itemcount; ++i )
		recv_data >> item_guid_masks[i];
	for( i = 0; i < itemcount; ++i )
	{
		recv_data >> itemslot;
//		recv_data >> itemguid;
		uint8 guid_bytes[8];
		memset( guid_bytes, 0 , sizeof( guid_bytes ) );
		if( item_guid_masks[i] & BIT_7 )
			recv_data >> guid_bytes[2];
		if( item_guid_masks[i] & BIT_4 )
			recv_data >> guid_bytes[0];
		if( item_guid_masks[i] & BIT_0 )
			recv_data >> guid_bytes[7];
		if( item_guid_masks[i] & BIT_5 )
			recv_data >> guid_bytes[1];
		if( item_guid_masks[i] & BIT_2 )
			recv_data >> guid_bytes[3];
		GUID_un_obfuscate( guid_bytes ); 

		uint64 itemguid = *(uint64*)(guid_bytes);
        pItem = _player->GetItemInterface()->GetItemByGUID( itemguid );
		uint32 real_item_slot = _player->GetItemInterface()->GetInventorySlotByGuid( itemguid );
		if( pItem == NULL || pItem->IsSoulbound() || pItem->HasFlag( ITEM_FIELD_FLAGS, ITEM_FLAG_CONJURED ) || 
			( pItem->IsContainer() && SafeContainerCast(pItem)->HasItems() ) || real_item_slot >= 0 && real_item_slot < INVENTORY_SLOT_ITEM_START )
		{
			SendMailError( MAIL_ERR_INTERNAL_ERROR );
			GetPlayer()->BroadcastMessage( "MailError:Item is either conjured or contains items itself" );
			return;
		}
		if(pItem->IsAccountbound() && GetAccountId() !=  player->acct) // don't mail account-bound items to another account
		{
//			SendMailError( MAIL_ERR_INTERNAL_ERROR );
			sStackWorldPacket( data, SMSG_SEND_MAIL_RESULT, 20 );
			data << uint32(0);
			data << uint32(0); 
			data << uint32(MAIL_ERR_BAG_FULL); 
			data << uint32(INV_ERR_ARTEFACTS_ONLY_FOR_OWN_CHARACTERS); 
			SendPacket(&data);
			GetPlayer()->BroadcastMessage( "MailError:This item is account bound" );
			return;
		}

		items.push_back( pItem );
	}
	
	//remaining bytes are for the mailbox GO guid
	
	bool interfaction = false;
	if( sMailSystem.MailOption( MAIL_FLAG_CAN_SEND_TO_OPPOSITE_FACTION ) || (HasGMPermissions() && sMailSystem.MailOption( MAIL_FLAG_CAN_SEND_TO_OPPOSITE_FACTION_GM ) ) )
	{
		interfaction = true;
	}

	// Check we're sending to the same faction (disable this for testing)
	if( player->team != _player->GetTeam() && !interfaction )
	{
		SendMailError( MAIL_ERR_NOT_YOUR_ALLIANCE );
		GetPlayer()->BroadcastMessage( "MailError:Can not send item to the other faction" );
		return;
	}

	// Check if we're sending mail to ourselves
	if( strcmp(player->name, _player->GetName()) == 0 && !GetPermissionCount())
	{
		SendMailError(MAIL_ERR_CANNOT_SEND_TO_SELF);
		GetPlayer()->BroadcastMessage( "MailError:Can not send mails to self" );
		return;
	}

	if( msg.stationery == MAIL_STATIONERY_GM && !HasGMPermissions())
	{
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:You are not allowed to send these type of mails" );
		return;
	}

	// Instant delivery time by default.
	msg.delivery_time = (uint32)UNIXTIME;

	// Set up the cost
	int32 cost = 0;

	// Check for attached money
	if( msg.money > 0 )
		cost += msg.money;

	if( cost < 0 )
	{
		SendMailError(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:Invalid gold amount" );
		return;
	}

	if( !sMailSystem.MailOption( MAIL_FLAG_DISABLE_POSTAGE_COSTS ) && !( GetPermissionCount() && sMailSystem.MailOption( MAIL_FLAG_NO_COST_FOR_GM ) ) )
	{
		cost += 30;
		if( cost < 30 )//Overflow prevention for those silly WPE hoez.
		{
			SendMailError(MAIL_ERR_INTERNAL_ERROR);
			GetPlayer()->BroadcastMessage( "MailError:Invalid Gold amount to be sent" );
			return;
		}			
	}	

	// check that we have enough in our backpack
	if( _player->GetGold( ) < cost )
	{
		SendMailError( MAIL_ERR_NOT_ENOUGH_MONEY );
		GetPlayer()->BroadcastMessage( "MailError:You do not have enough gold to send this mail" );
		return;
	}
	_player->Event_AchiementCriteria_Received(ACHIEVEMENT_CRITERIA_TYPE_GOLD_SPENT_FOR_MAIL,ACHIEVEMENT_UNUSED_FIELD_VALUE,ACHIEVEMENT_UNUSED_FIELD_VALUE,30,ACHIEVEMENT_EVENT_ACTION_ADD);

	// Check for the item, and required item.
	if( !items.empty( ) )
	{
		for( itr = items.begin(); itr != items.end(); ++itr )
		{
			pItem = *itr;
			if( _player->GetItemInterface()->SafeRemoveAndRetreiveItemByGuid(pItem->GetGUID(), false) != pItem )
				continue;		// should never be hit.

			pItem->RemoveFromWorld();
			pItem->SetOwner( NULL );
			pItem->SaveToDB( INVENTORY_SLOT_NOT_SET, 0, true, NULL );
			msg.items.push_back( pItem->GetUInt32Value(OBJECT_FIELD_GUID) );

			if( GetPermissionCount() > 0 )
			{
				/* log the message */
				sGMLog.writefromsession(this, "sent mail with item entry %u to %s, with gold %u.", pItem->GetEntry(), player->name, msg.money);
			}

			pItem->DeleteMe();
			pItem = NULL;
		}
	}

	if(msg.money != 0 || msg.cod != 0 || !msg.items.size() && player->acct != _player->GetSession()->GetAccountId())
	{
		if(!sMailSystem.MailOption(MAIL_FLAG_DISABLE_HOUR_DELAY_FOR_ITEMS))
			msg.delivery_time += 3600;  // 1hr
	}

	// take the money
	_player->ModGold( -cost);

	// Fill in the rest of the info
	msg.player_guid = player->guid;
	msg.sender_guid = _player->GetGUID();
	
	// 30 day expiry time for unread mail mail
	if(!sMailSystem.MailOption(MAIL_FLAG_NO_EXPIRY))
		msg.expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
	else
		msg.expire_time = 0;

	msg.copy_made = false;
	msg.read_flag = false;
	msg.deleted_flag = false;
	msg.message_type = 0;

	// Great, all our info is filled in. Now we can add it to the other players mailbox.
	sMailSystem.DeliverMessage(player->guid, &msg);
	// Save/Update character's gold if they've recieved gold that is. This prevents a rollback.
	CharacterDatabase.Execute("UPDATE `characters` SET `gold`='%u' WHERE (`guid`='%u')", _player->GetUInt32Value(PLAYER_FIELD_COINAGE), _player->m_playerInfo->guid);
	// Success packet :)
	SendMailError(MAIL_OK);
#if GM_STATISTICS_UPDATE_INTERVAL > 0 
	if( GetPlayer()->m_GM_statistics )
		GetPlayer()->m_GM_statistics->mails_sent++;
#endif
}

void WorldSession::HandleMarkAsRead(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0) 
	{ 
		return;
	}

	// mark the message as read
	message->read_flag = 1;

  // mail now has a minimum expiry time of 3 days and a maximum expiry time of 30 days
	if(!sMailSystem.MailOption(MAIL_FLAG_NO_EXPIRY))
  {
    if(message->expire_time > ((uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME)))
		  message->expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
    if(message->expire_time < ((uint32)UNIXTIME + (TIME_DAY * 3)))
      message->expire_time = (uint32)UNIXTIME + (TIME_DAY * 3);
  }
	
	// update it in sql
	CharacterDatabase.WaitExecute("UPDATE mailbox SET read_flag = 1, expiry_time = %u WHERE message_id = %u", message->expire_time, message->message_id);

  //TODO: Send changes to player... (read-mark and expiry time changed..)
}

void WorldSession::HandleMailDelete(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_DELETED);

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail." );
		SendPacket(&data);

		return;
	}

	if(message->copy_made)
	{
		// we have the message as a copy on the item. we can't delete it or this item
		// will no longer function.

		// deleted_flag prevents it from being shown in the mail list.
		message->deleted_flag = 1;

		// update in sql
		CharacterDatabase.WaitExecute("UPDATE mailbox SET deleted_flag = 1 WHERE message_id = %u", message_id);
	}
	else
	{
		// delete the message, there are no other references to it.
		_player->m_mailBox.DeleteMessage(message_id, true);
	}

	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleTakeItem(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	uint32 lowguid;
	vector< uint64 >::iterator itr;

	recv_data >> mailbox >> message_id >> lowguid;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_ITEM_TAKEN);
	
	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || message->items.empty())
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail." );
		SendPacket(&data);

		return;
	}

	for( itr = message->items.begin( ); itr != message->items.end( ); ++itr )
	{
		if ( (*itr) == lowguid )
			break;
	}

	if( itr == message->items.end( ) )
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail." );
		SendPacket(&data);

		return;
	}

	// check for cod credit
	if(message->cod > 0)
	{
		if(_player->GetGold() < message->cod)
		{
			data << uint32(MAIL_ERR_NOT_ENOUGH_MONEY);
			SendPacket(&data);
			return;
		}
	}

	// grab the item
	Item * item = objmgr.LoadItem( *itr );
	if(item == 0)
	{
		// doesn't exist
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this item." );
		SendPacket(&data);
		
		return;
	}

	// find a free bag slot
	SlotResult result = _player->GetItemInterface()->FindFreeInventorySlot(item->GetProto());
	if(result.Result == 0)
	{
		// no free slots left!
		data << uint32(MAIL_ERR_BAG_FULL);
		SendPacket(&data);

		item->DeleteMe();
		return;
	}

	// all is good
	// delete the item (so when its resaved it'll have an association)
	item->DeleteFromDB();

	// add the item to their backpack
	item->m_isDirty = true;

	// send complete packet
	data << uint32(MAIL_OK);
	data << item->GetUInt32Value(OBJECT_FIELD_GUID);
	data << item->GetUInt32Value(ITEM_FIELD_STACK_COUNT);

	if( !_player->GetItemInterface()->AddItemToFreeSlot(&item) )
	{
		item->DeleteMe();
		item = NULL;
	}

	message->items.erase( itr );

	// re-save (update the items field)
	sMailSystem.SaveMessageToSQL( message);
	SendPacket(&data);
	
	if( message->cod > 0 )
	{
		_player->ModGold( -int32(message->cod));
		string subject = "COD Payment: ";
		subject += message->subject;
		sMailSystem.SendAutomatedMessage(NORMAL, message->player_guid, message->sender_guid, subject, "", message->cod, 0, 0, MAIL_STATIONERY_TEST1 );

		message->cod = 0;
		CharacterDatabase.Execute("UPDATE mailbox SET cod = 0 WHERE message_id = %u", message->message_id);
	}

	// prolly need to send an item push here
}

void WorldSession::HandleTakeMoney(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_MONEY_TAKEN);

	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || !message->money)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail or missing gold." );
		return;
	}

	// add the money to the player
	_player->ModGold( message->money);

	// message no longer has any money
	message->money = 0;

	// update in sql!
	CharacterDatabase.WaitExecute("UPDATE mailbox SET money = 0 WHERE message_id = %u", message->message_id);

	// send result
	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleReturnToSender(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_RETURNED_TO_SENDER);

	MailMessage * msg = _player->m_mailBox.GetMessage(message_id);
	if(msg == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail." );
		return;
	}
	
	// copy into a new struct
	MailMessage message = *msg;

	// remove the old message
	_player->m_mailBox.DeleteMessage(message_id, true);

	// re-assign the owner/sender
	message.player_guid = message.sender_guid;
	message.sender_guid = _player->GetGUID();

	// turn off the read flag
	message.read_flag = false;
	message.deleted_flag = false;
	message.copy_made = false;

	// null out the cod charges. (the sender doesnt want to have to pay for his own item
	// that he got nothing for.. :p)
	message.cod = 0;

	// assign new delivery time
	message.delivery_time = message.items.empty() ? (uint32)UNIXTIME : (uint32)UNIXTIME + 3600;

	// add to the senders mailbox
	sMailSystem.DeliverMessage(message.player_guid, &message);

	// finish the packet
	data << uint32(MAIL_OK);
	SendPacket(&data);
}

void WorldSession::HandleMailCreateTextItem(WorldPacket & recv_data )
{
	uint64 mailbox;
	uint32 message_id;
	recv_data >> mailbox >> message_id;

	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << message_id << uint32(MAIL_RES_MADE_PERMANENT);

	ItemPrototype * proto = ItemPrototypeStorage.LookupEntry(8383);
	MailMessage * message = _player->m_mailBox.GetMessage(message_id);
	if(message == 0 || !proto)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);
		GetPlayer()->BroadcastMessage( "MailError:Could not find this mail." );
		return;
	}

	SlotResult result = _player->GetItemInterface()->FindFreeInventorySlot(proto);
	if(result.Result == 0)
	{
		data << uint32(MAIL_ERR_INTERNAL_ERROR);
		SendPacket(&data);
		GetPlayer()->BroadcastMessage( "MailError:No more free slots." );
		return;
	}

/*	
	3.3 is missing this
	Item * pItem = objmgr.CreateItem(8383, _player);
	pItem->SetUInt32Value(ITEM_FIELD_ITEM_TEXT_ID, message_id);
	if( _player->GetItemInterface()->AddItemToFreeSlot(&pItem) )
	{
		// mail now has an item after it
		message->copy_made = true;

		// update in sql
		CharacterDatabase.WaitExecute("UPDATE mailbox SET copy_made = 1 WHERE message_id = %u", message_id);

		data << uint32(MAIL_OK);
		SendPacket(&data);
	}
	else
	{
		pItem->DeleteMe();
	} */
}

void WorldSession::HandleItemTextQuery(WorldPacket & recv_data)
{
	uint32 message_id;
	recv_data >> message_id;

	string body = "Internal Error";

	MailMessage * msg = _player->m_mailBox.GetMessage(message_id);
	if(msg)
		body = msg->body;

	WorldPacket data(SMSG_ITEM_TEXT_QUERY_RESPONSE, body.length() + 5);
	data << message_id << body;
	SendPacket(&data);
}

void Mailbox::FillTimePacket(WorldPacket& data)
{
	/*
	!! for 24 mails not 1
{SERVER} Packet: (0x0284) MSG_QUERY_NEXT_MAIL_TIME PacketSize = 32 TimeStamp = 31642665
00 00 00 00
01 00 00 00 
6E DD FC 01 00 00 00 04 
00 00 00 00
00 00 00 00
29 00 00 00
00 00 58 C2 - 52 as float -> 52 seconds ?

14333
{SERVER} Packet: (0xFA62) MSG_QUERY_NEXT_MAIL_TIME PacketSize = 56 TimeStamp = 13039561
00 00 00 00
02 00 00 00
00 00 00 00 00 00 00 00 
C1 D4 00 00 
03 00 00 00 
29 00 00 00 
00 00 00 00 
61 77 F4 02 00 00 00 02 
00 00 00 00 
00 00 00 00 
29 00 00 00 
00 00 86 C2 
*/
	uint32 c = 0;
	MessageMap::iterator iter = Messages.begin();
	data << uint32(0) << uint32(0);

	for(; iter != Messages.end(); ++iter)
	{
		if(iter->second.deleted_flag == 0 && iter->second.read_flag == 0 && (uint32)UNIXTIME >= iter->second.delivery_time)
		{
			// unread message, w00t.
			++c;
			data << uint64(iter->second.sender_guid);
			data << uint32(0);
			data << uint32(iter->second.message_type);
			data << uint32(iter->second.stationery);
			data << float(UNIXTIME-iter->second.delivery_time);
			//Zack : blizz sends only 1 maybe we should send all ?
			break ;
		}
	}

	if(c==0)
	{
/*
{SERVER} Packet: (0x0284) MSG_QUERY_NEXT_MAIL_TIME PacketSize = 8 TimeStamp = 31448225
00 C0 A8 C7 
00 00 00 00 
*/
		*(uint32*)(&data.contents()[0])=0xc7a8c000;
	}
	else
	{
		*(uint32*)(&data.contents()[4])=c;
	}
}

void WorldSession::HandleMailTime(WorldPacket & recv_data)
{
	WorldPacket data(MSG_QUERY_NEXT_MAIL_TIME, 100);
	_player->m_mailBox.FillTimePacket(data);
	SendPacket(&data);
}

void WorldSession::SendMailError(uint32 error)
{
	WorldPacket data(SMSG_SEND_MAIL_RESULT, 12);
	data << uint32(0);
	data << uint32(MAIL_RES_MAIL_SENT);
	data << error;
	SendPacket(&data);
}

void WorldSession::HandleGetMail(WorldPacket & recv_data )
{
	WorldPacket * data = _player->m_mailBox.BuildMailboxListingPacket();
	SendPacket(data);
	delete data;
	data = NULL;
}

void MailSystem::RemoveMessageIfDeleted(uint32 message_id, Player * plr)
{
	MailMessage * msg = plr->m_mailBox.GetMessage(message_id);
	if(msg == 0) 
	{ 
		return;
	}

	if(msg->deleted_flag)   // we've deleted from inbox
		plr->m_mailBox.DeleteMessage(message_id, true);   // wipe the message
}

void MailSystem::SendAutomatedMessage(uint32 type, uint64 sender, uint64 receiver, string subject, string body,
									  uint64 money, uint32 cod, uint64 item_guid, uint32 stationery)
{
	// This is for sending automated messages, for example from an auction house.
	MailMessage msg;
	msg.message_type = type;
	msg.sender_guid = sender;
	msg.player_guid = receiver;
	msg.subject = subject;
	msg.body = body;
	msg.money = money;
	msg.cod = cod;
	if( GUID_LOPART(item_guid) != 0 )
		msg.items.push_back( GUID_LOPART(item_guid) );

	msg.stationery = stationery;
	msg.delivery_time = (uint32)UNIXTIME;
	msg.expire_time = (uint32)UNIXTIME + (TIME_DAY * MAIL_DEFAULT_EXPIRATION_TIME);
	msg.read_flag = false;
	msg.copy_made = false;
	msg.deleted_flag = false;

	// Send the message.
	DeliverMessage(receiver, &msg);
}

uint32 MailSystem::Generate_Message_Id()
{
	/** I know this is horrible. But when you have external mail sources unfortunately this is the only way to do this.
	 * - Burlex
	 */

	uint32 id = 1;
	QueryResult * result = CharacterDatabase.Query("SELECT MAX(message_id) FROM mailbox");
	if(result)
	{
		id = result->Fetch()[0].GetUInt32()+1;
		delete result;
		result = NULL;
	}

	return id;
}

void Mailbox::Load(QueryResult * result)
{
	if(!result)
	{ 
		return;
	}

	Field * fields;
	MailMessage msg;
	uint32 i;
	char * str;
	char * p;
	uint64 itemguid;

	do 
	{
		fields = result->Fetch();

		// Create message struct
		i = 0;
		msg.items.clear();
		msg.message_id = fields[i++].GetUInt32();
		msg.message_type = fields[i++].GetUInt32();
		msg.player_guid = fields[i++].GetUInt32();
		msg.sender_guid = fields[i++].GetUInt32();
		msg.subject = fields[i++].GetString();
		msg.body = fields[i++].GetString();
		msg.money = fields[i++].GetUInt32();
		str = (char*)fields[i++].GetString();
		p = strchr(str, ',');
		if( p == NULL )
		{
			itemguid = atoi(str);
			if( itemguid != 0 )
				msg.items.push_back( itemguid );
		}
		else
		{
			while( p )
			{
				*p = 0;
				p++;

				itemguid = atoi( str );
				if( itemguid != 0 )
					msg.items.push_back( itemguid );

                str = p;
				p = strchr( str, ',' );
			}
		}

		msg.cod = fields[i++].GetUInt32();
		msg.stationery = fields[i++].GetUInt32();
		msg.expire_time = fields[i++].GetUInt32();
		msg.delivery_time = fields[i++].GetUInt32();
		msg.copy_made = fields[i++].GetBool();
		msg.read_flag = fields[i++].GetBool();
		msg.deleted_flag = fields[i++].GetBool();

		if( msg.deleted_flag ) // cebernic : code for explito itemdupe
		{
			CharacterDatabase.Execute( "DELETE FROM mailbox WHERE message_id = %u", msg.message_id );
			continue;
		}
		else
		{
			msg.copy_made = false;
			CharacterDatabase.Execute( "UPDATE mailbox SET copy_made = 0 WHERE message_id = %u", msg.message_id	);
		}

		// Add to the mailbox
		AddMessage(&msg);

	} while(result->NextRow());
}
